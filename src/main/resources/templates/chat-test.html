<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MongoDB ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
  <h1>MongoDB ì‹¤ì‹œê°„ ì±„íŒ…</h1>
  <button onclick="connect()">ì±„íŒ… ì„œë²„ ì—°ê²°</button>
  <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
  <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
  <div id="messages"></div>

  <script>
    var stompClient = null;
    var name = "";

    // ğŸ”¥ ERPì˜ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    $(document).ready(function () {
      $.ajax({
        url: "http://127.0.0.1:9500/erp/member/getSessionUser", // ğŸ”¹ ERPì—ì„œ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        type: "GET",
        xhrFields: {
          withCredentials: true // âœ… ì„¸ì…˜ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ìš”ì²­
        },
        success: function (response) {
          if (response.status === "success") {
            name = response.name;  // ERP ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ì´ë¦„
            console.log("ğŸ”¹ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì: " + name);
          } else {
            console.log("âŒ ì‚¬ìš©ì ì •ë³´ ì—†ìŒ");
            name = "ìµëª…"; // ê¸°ë³¸ê°’
          }
        },
        error: function () {
          console.log("âŒ ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          name = "ìµëª…"; // ê¸°ë³¸ê°’
        }
      });
    });
    // âœ… ë¡œê·¸ì¸ ìš”ì²­ í•¨ìˆ˜
    function login() {
      $.ajax({
        url: "http://localhost:9500/erp/member/spring/login",
        type: "POST",
        contentType: "application/json",
        xhrFields: {
          withCredentials: true // âœ… ì„¸ì…˜ ë° ì¿ í‚¤ í¬í•¨
        },
        data: JSON.stringify({
          name: $("#name").val(),
          password: $("#password").val()
        }),
        success: function (response) {
          console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ:", response);
          alert("ë¡œê·¸ì¸ ì„±ê³µ: " + response.name);
          window.location.href = "/erp/index.html"; // ë¡œê·¸ì¸ í›„ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
        },
        error: function (xhr) {
          console.error("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨:", xhr.responseText);
          alert("ë¡œê·¸ì¸ ì‹¤íŒ¨! ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
      });
    }
    function connect() {
      if (!name || name === "ìµëª…") {
        alert("ë¡œê·¸ì¸ í›„ ì±„íŒ…ì„ ì´ìš©í•´ì£¼ì„¸ìš”!");
        return;
      }
      var socket = new SockJS("http://127.0.0.1:9500/chat/ws-stomp");
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
        console.log("âœ… ì„œë²„ ì—°ê²°ë¨! " + frame);

        // ğŸ”¥ ì„œë²„ í—¤ë” ì •ë³´ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ í›„ ì¶œë ¥
        if (frame.headers['server']) {
          console.log("connected to server " + frame.headers['server']);
        } else {
          console.log("connected to server (no server info provided)");
        }

        document.getElementById("messages").innerHTML += "<p>âœ… ì„œë²„ ì—°ê²°ë¨!</p>";

        // êµ¬ë… (ì„œë²„ì—ì„œ ë©”ì‹œì§€ë¥¼ ë°›ì„ ì¤€ë¹„)
        stompClient.subscribe("/topic/messages", function (message) {
          console.log("ğŸ“© ì„œë²„ì—ì„œ ë°›ì€ ë©”ì‹œì§€:", message.body);
          var receivedMessage = JSON.parse(message.body);
          document.getElementById("messages").innerHTML += "<p>ğŸ“© ë°›ì€ ë©”ì‹œì§€: " + receivedMessage.content + "</p>";
        });
      }, function(error) {
        console.error("âŒ WebSocket ì—°ê²° ì‹¤íŒ¨!", error);
        document.getElementById("messages").innerHTML += "<p>âŒ WebSocket ì—°ê²° ì‹¤íŒ¨!</p>";
      });
    }


    function sendMessage() {
      if (stompClient && stompClient.connected) {
        var chatMessage = {
          name: name,
          roomName: "ê°œë°œíŒ€ ì±„íŒ…ë°©",
          content: document.getElementById("messageInput").value
        };
        console.log("ğŸ“¤ ë³´ë‚¼ ë©”ì‹œì§€:", chatMessage); // âœ… ë³´ë‚¼ ë©”ì‹œì§€ ì½˜ì†” ì¶œë ¥
        stompClient.send("/app/chat", {}, JSON.stringify(chatMessage));
        console.log("ğŸ“¨ ë©”ì‹œì§€ê°€ ì„œë²„ë¡œ ì „ì†¡ë¨: /app/chat");
        document.getElementById("messages").innerHTML += "<p>ğŸ“¤ ë©”ì‹œì§€ ë³´ëƒ„: " + chatMessage.content + "</p>";
      } else {
        alert("ë¨¼ì € ì±„íŒ… ì„œë²„ì— ì—°ê²°í•˜ì„¸ìš”!");
      }
    }
  </script>
</body>
</html>
