<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>MongoDB 채팅 테스트</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<body>
  <h1>MongoDB 실시간 채팅</h1>
  <button onclick="connect()">채팅 서버 연결</button>
  <input type="text" id="messageInput" placeholder="메시지를 입력하세요">
  <button onclick="sendMessage()">보내기</button>
  <div id="messages"></div>

  <script>
    var stompClient = null;
    var name = "";

    // 🔥 ERP의 로그인된 사용자 정보 가져오기
    $(document).ready(function () {
      $.ajax({
        url: "http://127.0.0.1:9500/erp/member/getSessionUser", // 🔹 ERP에서 로그인된 사용자 정보 가져오기
        type: "GET",
        xhrFields: {
          withCredentials: true // ✅ 세션 정보를 포함하여 요청
        },
        success: function (response) {
          if (response.status === "success") {
            name = response.name;  // ERP 로그인된 사용자 이름
            console.log("🔹 로그인된 사용자: " + name);
          } else {
            console.log("❌ 사용자 정보 없음");
            name = "익명"; // 기본값
          }
        },
        error: function () {
          console.log("❌ 사용자 정보를 가져올 수 없습니다.");
          name = "익명"; // 기본값
        }
      });
    });
    // ✅ 로그인 요청 함수
    function login() {
      $.ajax({
        url: "http://localhost:9500/erp/member/spring/login",
        type: "POST",
        contentType: "application/json",
        xhrFields: {
          withCredentials: true // ✅ 세션 및 쿠키 포함
        },
        data: JSON.stringify({
          name: $("#name").val(),
          password: $("#password").val()
        }),
        success: function (response) {
          console.log("✅ 로그인 성공:", response);
          alert("로그인 성공: " + response.name);
          window.location.href = "/erp/index.html"; // 로그인 후 대시보드로 이동
        },
        error: function (xhr) {
          console.error("❌ 로그인 실패:", xhr.responseText);
          alert("로그인 실패! 아이디와 비밀번호를 확인해주세요.");
        }
      });
    }
    function connect() {
      if (!name || name === "익명") {
        alert("로그인 후 채팅을 이용해주세요!");
        return;
      }
      var socket = new SockJS("http://127.0.0.1:9500/chat/ws-stomp");
      stompClient = Stomp.over(socket);

      stompClient.connect({}, function (frame) {
        console.log("✅ 서버 연결됨! " + frame);

        // 🔥 서버 헤더 정보가 존재하는지 확인 후 출력
        if (frame.headers['server']) {
          console.log("connected to server " + frame.headers['server']);
        } else {
          console.log("connected to server (no server info provided)");
        }

        document.getElementById("messages").innerHTML += "<p>✅ 서버 연결됨!</p>";

        // 구독 (서버에서 메시지를 받을 준비)
        stompClient.subscribe("/topic/messages", function (message) {
          console.log("📩 서버에서 받은 메시지:", message.body);
          var receivedMessage = JSON.parse(message.body);
          document.getElementById("messages").innerHTML += "<p>📩 받은 메시지: " + receivedMessage.content + "</p>";
        });
      }, function(error) {
        console.error("❌ WebSocket 연결 실패!", error);
        document.getElementById("messages").innerHTML += "<p>❌ WebSocket 연결 실패!</p>";
      });
    }


    function sendMessage() {
      if (stompClient && stompClient.connected) {
        var chatMessage = {
          name: name,
          roomName: "개발팀 채팅방",
          content: document.getElementById("messageInput").value
        };
        console.log("📤 보낼 메시지:", chatMessage); // ✅ 보낼 메시지 콘솔 출력
        stompClient.send("/app/chat", {}, JSON.stringify(chatMessage));
        console.log("📨 메시지가 서버로 전송됨: /app/chat");
        document.getElementById("messages").innerHTML += "<p>📤 메시지 보냄: " + chatMessage.content + "</p>";
      } else {
        alert("먼저 채팅 서버에 연결하세요!");
      }
    }
  </script>
</body>
</html>
